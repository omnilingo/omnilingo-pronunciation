<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Compare</title>
    <style>
        table, th, td {
            border:1px solid black;
            border-collapse: collapse;
            text-align: center;
            margin-left:auto;
            margin-right:auto;
            padding: 5px;
        }
    </style>
</head>
<body>
<div style="text-align: center">
    <br><br>
    <table id="feedback_table">
        <colgroup id="table_colgroup">
            <col>
        </colgroup>
        <tr id="text">
        </tr>
        <tr id="gold_scores">
        </tr>
        <tr id="test_scores">
        </tr>
        <tr id="cosine">
        </tr>
    </table>
    <br>
    <span>gold file name</span>
    <input type="text" id="gold_filename" value="data/gold.json"><br>
    <span>test file name</span>
    <input type="text" id="filename" value="data/test-1.json">
    <br>
    <button type="button" onclick="run_compare()">Compare</button>
</div>
</body>
</html>

<script src="compare.js"></script>

<script>
    function get_logit_chars(logits, alphabet) {
        let logit_chars = [];
        for (let i = 0; i < logits.length; i ++) {
            let max_logit = 0.0;
            let max_index = 0;
            for (let j = 0; j < logits[i].length; j++) {
                if (logits[i][j] > max_logit) {
                    max_logit = logits[i][j];
                    max_index = j;
                }
            }
            logit_chars[i] = alphabet[max_index];
        }
        return logit_chars;
    }

    async function run_compare() {
        // initialize variables
        let filename = document.getElementById("filename").value;
        let gold_filename = document.getElementById("gold_filename").value;
        let feedback_table = document.getElementById("feedback_table");
        let colgroup = document.getElementById("table_colgroup");
        let text_row = document.getElementById("text");
        let gold_row = document.getElementById("gold_scores");
        let test_row = document.getElementById("test_scores");
        let cosine_row = document.getElementById("cosine");

        // reset table
        colgroup.innerHTML = "<col>";
        text_row.innerHTML = "<td>Sentence: </td>";
        gold_row.innerHTML = "<td>Gold Scores: </td>";
        test_row.innerHTML = "<td>Test Scores: </td>";
        cosine_row.innerHTML = "<td>Cosine Scores:</td>";

        // load data from json files
        const test = await fetch(filename)
            .then(function (response) {
                return response.json();
            });
        const gold = await fetch(gold_filename)
            .then(function (response) {
                return response.json();
            });

        // retrieve gold text from gold json
        let gold_phrase = "";
        for (let i = 0; i < gold.words.length; i++) {
            gold_phrase += gold.words[i].word + (i === gold.words.length - 1 ? '' : ' ');
        }

        // map alphabet characters to their index
        let alphabet_index = new Map();
        for (let i = 0; i < gold.alphabet.length; i++) {
            alphabet_index.set(gold.alphabet[i], i);
        }

        // set cells to gold text
        for (let i = 0; i < gold_phrase.length; i++) {
            let new_cell = text_row.insertCell();
            new_cell.innerText = gold_phrase[i];
        }

        // get logit characters
        let gold_logit_chars = get_logit_chars(gold.logits, gold.alphabet);
        let test_logit_chars = get_logit_chars(test.logits, test.alphabet);

        // retrieve alignments
        let gold_align = needleman_wunsch_align(gold_phrase, gold_logit_chars);
        let test_align = needleman_wunsch_align(gold_phrase, test_logit_chars);
        // console.log(gold_align);
        // console.log(test_align);

        let best_golds = [];
        let best_tests = [];

        // get highest score for each character in gold
        let c = 0;
        let c_index = alphabet_index.get(gold_phrase[0]);
        // have to create array of length for comparitor using a[c_index]
        let a = new Array(gold.logits[0].length).fill(0.0);
        for (let i = 0; i < gold_align.length; i++) {
            if (gold_align[i][0] !== c) { // save best gold and increment c
                best_golds[c] = a;
                a = new Array(gold.logits[0].length).fill(0.0);
                c++;
                c_index = alphabet_index.get(gold_phrase[c]);
            }
            console.log(c + ': ' + c_index);
            console.log(gold.logits[gold_align[i][1]]);
            if (gold.logits[gold_align[i][1]][c_index] > a[c_index]) {
                a = gold.logits[gold_align[i][1]];
            }
            // if (Math.max(...gold.logits[gold_align[i][1]]) > Math.max(...a)) {
            //     a = gold.logits[gold_align[i][1]];
            // }
        }
        best_golds[c] = a;

        // get highest score for each character in test
        c = 0;
        c_index = alphabet_index.get(gold_phrase[0]);
        a = new Array(gold.logits[0].length).fill(0.0);
        for (let i = 0; i < test_align.length; i++) {
            if (test_align[i][0] !== c) { // save best test and increment c
                best_tests[c] = a;
                a = new Array(gold.logits[0].length).fill(0.0);
                c++;
                c_index = alphabet_index.get(gold_phrase[c]);
            }
            console.log(c + ': ' + c_index);
            console.log(test.logits[test_align[i][1]]);
            if (test.logits[test_align[i][1]][c_index] > a[c_index]) {
                a = test.logits[test_align[i][1]];
            }
            // if (Math.max(...test.logits[test_align[i][1]]) > Math.max(...a)) {
            //     a = test.logits[test_align[i][1]];
            // }
        }
        best_tests[c] = a;

        // insert the gold characters into the table
        for (let i = 0; i < best_golds.length; i++) {
            let new_cell = gold_row.insertCell();
            let new_col = document.createElement("col");
            new_col.style.backgroundColor = "rgba(255, 0, 0, " + (1 - best_golds[i][alphabet_index.get(gold_phrase[i])]) + ")"
            colgroup.append(new_col);
            // new_cell.innerText = cosinesim(best_golds[i], best_tests[i]).toFixed(3);
            new_cell.innerText = best_golds[i][alphabet_index.get(gold_phrase[i])].toFixed(3);
        }

        // insert the raw max test scores into the table
        for (let i = 0; i < best_tests.length; i++) {
            let new_cell = test_row.insertCell();
            new_cell.innerText = best_tests[i][alphabet_index.get(gold_phrase[i])].toFixed(3);
        }

        for (let i = 0; i < best_golds.length; i++) {
            let new_cell = cosine_row.insertCell();
            // console.log("best gold at " + i + ": " + best_golds[i]);
            // console.log("best test at " + i + ": " + best_tests[i]);
            new_cell.innerText = cosinesim(best_golds[i], best_tests[i]).toFixed(3);
            // new_cell.innerText = Math.max(...best_golds[i]).toFixed(3);
        }

//         for (let i = 0; i < best_golds.length; i++) {
//             let new_cell = feedback_row.insertCell(i);
//             // new_cell.innerText = cosinesim(best_golds[i], best_tests[i]);
//             let colour = 'rgb(0,' + (Math.max(...best_golds[i]) * 200) + ',0)';
//                let text = Math.max(...best_golds[i]).toFixed(2);
//                new_cell.innerHTML = '<span style="color:' + colour + '">' + text + '</span>';
//                new_cell.innerText = Math.max(...best_golds[i]).toFixed(2);
//         }

    }
</script>
